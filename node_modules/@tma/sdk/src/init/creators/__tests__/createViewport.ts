import { mockSessionStorageGetItem } from './test-utils';
import type { SpyInstance } from './vitest';
import { afterEach, expect, it, vi } from './vitest';

import { createWindow } from '../../../../test-utils/createWindow.ts';
import { createViewport } from '../createViewport.ts';
import { requestViewport } from '../../../components/viewport/requestViewport.ts';

vi.mock('../../../components/viewport/requestViewport', () => {
  return {
    requestViewport: vi.fn(),
  };
});

type RequestViewport = typeof requestViewport;

const requestViewportMock = requestViewport as unknown as SpyInstance<Parameters<RequestViewport>, ReturnType<RequestViewport>>;

afterEach(() => {
  vi.restoreAllMocks();
  requestViewportMock.mockReset();
});

it('should create Viewport from the data located in the storage if page was reloaded and storage has viewport data', () => {
  mockSessionStorageGetItem('{"height":992,"isExpanded":false,"stableHeight":992,"width":320}');
  expect(createViewport(true, 'macos', vi.fn(), false)).toMatchObject({
    height: 992,
    isExpanded: false,
    stableHeight: 992,
    width: 320,
  });
});

it('should return viewport with window data if page was not reloaded or storage is missing required data, and platform has a stable viewport', () => {
  createWindow({ innerHeight: 1000, innerWidth: 2000 });
  expect(createViewport(false, 'macos', vi.fn(), false)).toMatchObject({
    height: 1000,
    isExpanded: true,
    stableHeight: 1000,
    width: 2000,
  });

  expect(createViewport(true, 'macos', vi.fn(), false)).toMatchObject({
    height: 1000,
    isExpanded: true,
    stableHeight: 1000,
    width: 2000,
  });
});

it('should create Viewport instance from the result of calling requestViewport function if page was not reloaded, platform has no stable viewport and initialization is complete', () => {
  requestViewportMock.mockImplementation(async () => ({
    height: 922,
    isStateStable: false,
    width: 800,
    isExpanded: false,
  }));

  expect(createViewport(false, 'android', vi.fn(), true)).resolves.toMatchObject({
    height: 922,
    isExpanded: false,
    stableHeight: 0,
    width: 800,
  });

  requestViewportMock.mockImplementation(async () => ({
    height: 111,
    isStateStable: true,
    width: 222,
    isExpanded: true,
  }));

  expect(createViewport(false, 'android', vi.fn(), true)).resolves.toMatchObject({
    height: 111,
    isExpanded: true,
    stableHeight: 111,
    width: 222,
  });
});

it('should return viewport with zeroes if page was reloaded, storage doesnt contain data, platform has no stable viewport and initialization is not complete', () => {
  requestViewportMock.mockImplementation(async () => ({
    height: 922,
    isStateStable: false,
    width: 800,
    isExpanded: false,
  }));

  mockSessionStorageGetItem(null);
  expect(createViewport(true, 'android', vi.fn(), false)).toMatchObject({
    height: 0,
    isExpanded: false,
    stableHeight: 0,
    width: 0,
  });
});
